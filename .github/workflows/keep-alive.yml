name: "Keep-Alive ‚Äî Anti-Sleep Ping"

on:
  schedule:
    # A cada 5 minutos (m√≠nimo suportado pelo GitHub Actions)
    - cron: "*/5 * * * *"
  # Permite disparo manual para testes
  workflow_dispatch:

jobs:
  ping:
    name: "Ping /health"
    runs-on: ubuntu-latest

    steps:
      - name: "Ping Production /health"
        run: |
          URL="https://imm-api.onrender.com/health"
          echo "üèì Pingando: $URL"

          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 20 "$URL")
          STATUS=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "HTTP: $STATUS"
          echo "Body: $BODY"

          # N√£o falha o job para n√£o gerar notifica√ß√£o de erro desnecess√°ria
          # O Render pode demorar alguns segundos para "acordar" na primeira request
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Servidor ativo!"
          else
            echo "‚ö†Ô∏è Servidor acordando ou com problema (HTTP $STATUS)"
          fi

      - name: "Ping Staging /health"
        if: ${{ secrets.RENDER_STAGING_URL != '' }}
        run: |
          URL="${{ secrets.RENDER_STAGING_URL }}/health"
          echo "üèì Pingando staging: $URL"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 20 "$URL" || echo "000")
          echo "HTTP: $STATUS"

          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Staging ativo!"
          else
            echo "‚ö†Ô∏è Staging com HTTP $STATUS"
          fi
