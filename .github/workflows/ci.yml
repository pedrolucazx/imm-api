name: CI — imm-api

on:
  pull_request:
    branches:
      - develop

permissions:
  contents: read
  pull-requests: write # Necessário para o CodeRabbit

jobs:
  quality_gate:
    name: "Quality Gate (Lint, Types, Tests)"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: imm
          POSTGRES_PASSWORD: imm_password
          POSTGRES_DB: imm_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://imm:imm_password@localhost:5432/imm_test
      NODE_ENV: test
      JWT_SECRET: ci-test-jwt-secret-that-is-at-least-32-characters-long

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Step 1: Code Quality (Lint & Format)"
        run: |
          npm run lint
          npm run format:check

      - name: "Step 2: Type Check & Automated Tests"
        run: |
          npx tsc --noEmit
          npm run test:unit
          npm run db:migrate
          npm run test:integration

      - name: "Step 3: AI Code Review (CodeRabbit)"
        if: success() # Só executa se os passos anteriores passarem
        uses: coderabbitai/ai-pr-reviewer@latest
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
