name: CD â€” Deploy (Render)

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: deploy-api-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy to Render (${{ github.ref_name }})"
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'homolog' }}
      url: ${{ github.ref_name == 'main' && 'https://imm-production.onrender.com' || 'https://imm-homolog.onrender.com' }}

    steps:
      - name: "Trigger Render Deploy Hook"
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            HOOK_URL="${{ secrets.RENDER_DEPLOY_HOOK_PROD }}"
          else
            HOOK_URL="${{ secrets.RENDER_DEPLOY_HOOK_HOMOLOG }}"
          fi

          echo "Triggering Render deploy for ${{ github.ref_name }}"

          RESPONSE=$(curl -sS -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            -X POST "$HOOK_URL")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "Deploy triggered successfully (HTTP $RESPONSE)"
          else
            echo "Failed to trigger deploy (HTTP $RESPONSE)"
            exit 1
          fi
