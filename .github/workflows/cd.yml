name: "CD ‚Äî Deploy (Render)"

on:
  push:
    branches:
      - main # ‚Üí Produ√ß√£o
      - develop # ‚Üí Staging
  workflow_dispatch: # Permite trigger manual

# Garante que apenas 1 deploy rode por vez por branch
concurrency:
  group: deploy-api-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy to Render (${{ github.ref_name }})"
    runs-on: ubuntu-latest
    environment:
      # Environments criados em: Settings ‚Üí Environments
      name: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
      url: ${{ github.ref_name == 'main' && 'https://imm-api.onrender.com' || 'https://imm-api-staging.onrender.com' }}

    steps:
      - name: "Trigger Render Deploy Hook"
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            HOOK_URL="${{ secrets.RENDER_DEPLOY_HOOK_PROD }}"
            ENV_LABEL="produ√ß√£o"
          else
            HOOK_URL="${{ secrets.RENDER_DEPLOY_HOOK_STAGING }}"
            ENV_LABEL="staging"
          fi

          echo "üöÄ Disparando deploy no Render para: $ENV_LABEL"

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            -X POST "$HOOK_URL")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "‚úÖ Deploy disparado! (HTTP $RESPONSE)"
          else
            echo "‚ùå Falha ao disparar o deploy. (HTTP $RESPONSE)"
            exit 1
          fi

      - name: "Aguardar o servi√ßo ficar dispon√≠vel (/health)"
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            HEALTH_URL="https://imm-api.onrender.com/health"
          else
            HEALTH_URL="https://imm-api-staging.onrender.com/health"
          fi

          echo "‚è≥ Validando disponibilidade em: $HEALTH_URL"
          MAX_RETRIES=20
          WAIT=15

          for i in $(seq 1 $MAX_RETRIES); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Servi√ßo respondendo! (tentativa $i)"
              exit 0
            fi
            echo "  [$i/$MAX_RETRIES] HTTP $STATUS ‚Äî pr√≥xima tentativa em ${WAIT}s..."
            sleep $WAIT
          done

          echo "‚ùå Timeout: servi√ßo n√£o ficou dispon√≠vel ap√≥s $((MAX_RETRIES * WAIT))s."
          exit 1
